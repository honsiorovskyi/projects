#!/bin/bash
# vim:ft=bash
#
# Clone repos into a project directory using local cache for speed

set -e

if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  cat <<EOF
Usage: pclone <repo1> [repo2] [repo3] ...

Clone repositories into the current project directory and create a branch
named after the project.

Uses a local bare repo cache (~/.cache/p.repos) for faster subsequent clones.
First clone fetches from remote and creates cache; subsequent clones use
cache as reference and only fetch deltas.

Requirements:
  - Must be run from inside \$PROJECTS_HOME/<project_name>
  - PROJECTS_GIT_BASE or GITHUB_ORG must be set

Environment:
  PROJECTS_HOME       Base projects directory (default: ~/projects)
  PROJECTS_GIT_BASE   Git URL prefix for cloning (default: git@github.com:\$GITHUB_ORG)
  PROJECTS_CACHE_REPOS  Cache directory (default: ~/.cache/p.repos)
  GITHUB_ORG          GitHub org (used to derive PROJECTS_GIT_BASE if not set)
EOF
  exit 0
fi

PROJECTS_HOME="${PROJECTS_HOME:-$HOME/projects}"
PROJECTS_CACHE_REPOS="${PROJECTS_CACHE_REPOS:-$HOME/.cache/p.repos}"

# Derive PROJECTS_GIT_BASE from GITHUB_ORG if not set
if [[ -z "$PROJECTS_GIT_BASE" && -n "$GITHUB_ORG" ]]; then
  PROJECTS_GIT_BASE="git@github.com:$GITHUB_ORG"
fi

# Check if we're in a project directory
if [[ "$PWD" != "$PROJECTS_HOME"/* ]]; then
  echo "Error: Must be inside a project directory ($PROJECTS_HOME/<project_name>)" >&2
  exit 1
fi

# Check if PROJECTS_GIT_BASE is defined
if [[ -z "$PROJECTS_GIT_BASE" ]]; then
  echo "Error: Set PROJECTS_GIT_BASE or GITHUB_ORG" >&2
  exit 1
fi

# Check if at least one repo is specified
if [[ $# -eq 0 ]]; then
  echo "Usage: pclone <repo1> [repo2] [repo3] ..." >&2
  exit 1
fi

# Extract project name from current path
project_name=$(echo "$PWD" | sed "s|$PROJECTS_HOME/||" | cut -d'/' -f1)

mkdir -p "$PROJECTS_CACHE_REPOS"

for repo in "$@"; do
  cache_repo="$PROJECTS_CACHE_REPOS/${repo}.git"
  
  if [[ -d "$cache_repo" ]]; then
    # Update existing cache
    git -C "$cache_repo" fetch --depth 1 --prune
  else
    # Create new shallow bare cache (single branch only)
    git clone --bare --depth 1 --single-branch "${PROJECTS_GIT_BASE}/${repo}.git" "$cache_repo"
  fi
  
  # Clone from local cache (fast)
  git clone --single-branch "$cache_repo" "$repo"
  
  # Repoint remote to actual origin and fetch latest
  (
    cd "$repo"
    git remote set-url origin "${PROJECTS_GIT_BASE}/${repo}.git"
    git fetch --depth 1
    git checkout -b "$project_name"
  )
done
